<html xmlns:fb="http://ogp.me/ns/fb#">
<head>
	<title>Express Message Board</title>
	<!-- <link rel="stylesheet" type="text/css" href="http://necolas.github.io/normalize.css/1.1.2/normalize.css"> -->
	<link rel="stylesheet" type="text/css" href="public/css/styles.css">
	<link href='http://fonts.googleapis.com/css?family=Merriweather:300,700' rel='stylesheet' type='text/css'>
	<script type="text/javascript" src="/socket.io/socket.io.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>
	<script type="text/javascript">
		$(function () {
			var socket = io.connect("/"); //like a persistent tube between client and server on directory '/'

			$.get("/messages", function(data) {
				var i = 0;
				for (i = 0; i < data.length; i++) {
					var txt = $("<p data-msgID='" + data.ID + "'>" + data[i].content + "</p>");
					var upVoteBtn = $('<button class="upVoteBtn" data-msgID="' + data[i].ID + '">&#8743;</button>');
					var downVoteBtn = $('<button class="downVoteBtn" data-msgID="' + data[i].ID + '">&#8744;</button>');
					var votesDisplay = $('<span class="votes" data-msgID="' + data[i].ID + '">0</span>');
					if (data[i].vote) {
						votesDisplay.text(data[i].vote);
					}
					upVoteBtn.click(upVote);
					downVoteBtn.click(downVote);
					$("#messageBoard").append(txt).append(upVoteBtn).append(downVoteBtn).append(votesDisplay);
				}

			});

			//------------- It's a good idea to avoid default "message" channel --------------
			socket.on("msgEntry", function(data) { //event listener, when server sends message, do the below operation
				var txt = $("<p data-msgID='" + data.ID + "'>" + data.content + "</p>");
				var upVoteBtn = $('<button class="upVoteBtn" data-msgID="' + data.ID + '">&#8743;</button>');
				var downVoteBtn = $('<button class="downVoteBtn" data-msgID="' + data.ID + '">&#8744;</button>');
				var votesDisplay = $('<span class="votes" data-msgID="' + data.ID + '">0</span>');
				upVoteBtn.click(upVote);
				downVoteBtn.click(downVote);
				$("#messageBoard").append(txt).append(upVoteBtn).append(downVoteBtn).append(votesDisplay);
			});

			$("#sendBtn").click(function() {
				var msgText = $("#msgText").val();
				socket.emit("msgEntry", msgText); //we're no longer sending a POST, we do socket.emit
				$("#msgText").focus().val("");
			});

			//----- Minimal voting. It's not stored into db yet as I'm not sure how the structure will be like yet------
			//----- @boyang
			function upVote() {
				socket.emit('vote', {ID: $(this).attr("data-msgID"), value: 1});
			}
			function downVote() {
				socket.emit('vote', {ID: $(this).attr("data-msgID"), value: -1});
			}

			// Initiates FB object
			window.fbAsyncInit = function() {
			FB.init({ appId: '492242497533605', 
				status: true, 
				cookie: true,
				xfbml: true,
				oauth: true
			});

			function updateLogin(response) {
				var $loginButton = $('#login-button');
				if (response.authResponse) {
					// logged in and connected
					// Query user profile
					FB.api('/me', function(response) {
						$loginButton.text(response.first_name);
					});
					$loginButton.off('click.login');
					$loginButton.on('click.logout', function(){
						FB.logout(function(response) {
							$loginButton.text('Login');
						})
					})
				} else {
					// logged out
					$loginButton.off('click.logout');
					$loginButton.on('click.login', function(){
						FB.login(function(response){
							if (response.authResponse) {
								FB.api('/me', function(response) {
									$loginButton.text(response.first_name);
								});
							} else {

							}
						}, {scope: 'email'});
					})
				}
			}
			// run once with current status and whenever the status changes
			FB.getLoginStatus(updateLogin);
			FB.Event.subscribe('auth.statusChange', updateLogin);    
		  };

		// End of document.ready
		});
	</script>
</head>
<body>
	<div id="fb-root"></div>
	<script>(function(d, s, id) {
		var js, fjs = d.getElementsByTagName(s)[0];
		if (d.getElementById(id)) return;
		js = d.createElement(s); js.id = id;
		js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=492242497533605";
		fjs.parentNode.insertBefore(js, fjs);
	}(document, 'script', 'facebook-jssdk'));</script>

		<header>
			<div class ="container">
				<h1><a href="/">ProjectName</a></h1>
				<ul>
					<li><a class='login' href="#" id="login-button">Login</a></li>
					<li><a href="">Dashboard</a></li>
					<li><a href="">My Classes</a></li>
				</ul>
			</div>
		</header>

		<div id="hero">
			<div class ="container">
				<span>
					<h2>CS1231: Discrete Structures</h2>
					<h3>Assoc. Prof. St√©phane Bressane</h3>
				</span>
			</div>
		</div>

		<div class='msgwrap'>
			<div class ="container">
				<div id="messageBoard"></div>
				<div id="messageInput">
					<input id="msgText" type="text" autofocus placeholder="Your message here"/>
					<button id="sendBtn">Send</button>
				</div>
			</div>
		</div>

		<div class="like-button">
			<fb:like href="http://la.cmq.me" width="90px" layout="button_count" show_faces="true" send="false"></fb:like>
		</div>
</body>
</html>